<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Brian's SSE Chat</title>
    <link
      href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="font-mono">
    <div
      id="login-container"
      class="h-screen flex content-center items-center justify-center"
    >
      <div class="">
        <h1 class="mb-5 text-2xl">Join Brian's SSE Chat</h1>
        <form id="author-form">
          <div class="mb-1">
            <label>Display name</label>
            <input
              class="border flex-grow w-full px-3 py-1 mb-1"
              type="text"
              name="author"
            />
          </div>
          <label>Color</label>
          <div class="border w-full flex mb-1">
            <span class="pl-3 pr-1 py-1">#</span>
            <input
              class="flex-grow pr-3 py-1"
              type="text"
              name="color"
              style="color: #000000;"
            />
          </div>
          <button
            type="submit"
            class="px-3 py-1 bg-purple-600 text-white w-full"
          >
            Join
          </button>
        </form>
      </div>
    </div>
    <div id="chat-container" class="flex flex-col max-h-screen hidden">
      <div class="bg-purple-600 text-white flex justify-between px-3 py-1">
        <p>Signed in as <span class="bg-white p-1" id="author"></span></p>
        <button id="logout">Sign out</button>
      </div>
      <div id="chat" class="flex-grow overflow-auto px-3 h-screen"></div>
      <div class="w-full bg-white pt-1">
        <button
          class="mx-auto bg-purple-600 text-white px-3 py-1 mb-1 hidden"
          id="autoscroll"
        >
          Scroll with chat
        </button>
        <form id="message-form">
          <div class="flex">
            <input
              class="border flex-grow w-full px-3 py-1"
              type="text"
              name="message"
            />
            <button type="submit" class="px-3 py-1 bg-purple-600 text-white">
              Send
            </button>
          </div>
        </form>
      </div>
    </div>
    <script type="text/javascript">
      const state = {
        color: "",
        author: "",
      };

      const messageForm = document.getElementById("message-form");
      messageForm.addEventListener("submit", function (e) {
        e.preventDefault();

        // Get the message.
        const message = messageForm.elements["message"].value;

        // Clear the message box.
        messageForm.elements["message"].value = "";

        const req = new XMLHttpRequest();
        req.open("POST", "/api/chat", true);
        req.setRequestHeader("Content-Type", "application/json");
        req.send(
          JSON.stringify({ author: state.author, color: state.color, message })
        );
      });

      const autoScrollButton = document.getElementById("autoscroll");
      const target = document.getElementById("chat");

      let autoScroll = true;
      autoScrollButton.addEventListener("click", function () {
        // Turn back on scrolling.
        autoScroll = true;

        // Scroll now.
        target.scrollTop = target.scrollHeight - target.clientHeight;

        // Hide this button.
        autoScrollButton.style.display = "";
      });

      target.addEventListener("wheel", function () {
        autoScroll = false;
        autoScrollButton.style.display = "block";
      });

      let sse = null;
      function connect(author) {
        if (sse) {
          sse.close();
          sse = null;
        }

        sse = new EventSource(
          "/api/messages?author=" + encodeURIComponent(author)
        );
        sse.onmessage = function (e) {
          const payload = JSON.parse(e.data);

          const author = document.createElement("div");
          author.className = "mr-1";
          author.style.color = payload.color;
          author.innerText = payload.author + ":";

          const message = document.createElement("div");
          message.innerText = payload.message;
          if (payload.author === "system") {
            message.className = "text-gray-500";
          }

          const line = document.createElement("div");
          line.className = "flex mr-1";
          line.appendChild(author);
          line.appendChild(message);

          const time = document.createElement("div");
          time.className = "text-gray-300 whitespace-no-wrap";
          time.innerText = new Date().toLocaleTimeString();

          const container = document.createElement("div");
          container.className = "mb-1 flex justify-between";
          container.appendChild(line);
          container.appendChild(time);

          target.appendChild(container);

          if (autoScroll) {
            target.scrollTop = target.scrollHeight - target.clientHeight;
          }
        };
      }

      function logout() {
        // Clear the items from storage.
        sessionStorage.removeItem("author");
        sessionStorage.removeItem("color");

        // Update the state.
        state.author = "";
        state.color = "";

        document.getElementById("login-container").style.display = "flex";
        document.getElementById("chat-container").style.display = "none";
      }

      const logoutButton = document.getElementById("logout");
      logoutButton.addEventListener("click", () => {
        logout();
      });

      function login(author, color) {
        // Validate the author.
        if (!author || author.length <= 0) {
          return;
        }

        if (author.toLowerCase() === "system") {
          return;
        }

        // Validate the color.
        if (!color || color.length <= 1) {
          return;
        }

        // Looks good! Let's save these defaults and get going.
        sessionStorage.setItem("author", author);
        sessionStorage.setItem("color", color);

        // Update the state.
        state.author = author;
        state.color = color;

        // Update links.
        const authorBox = document.getElementById("author");
        authorBox.innerText = author;
        authorBox.style.color = color;

        // Hide the login container, show the chat container.
        document.getElementById("login-container").style.display = "none";
        document.getElementById("chat-container").style.display = "flex";

        // Connect to the chat.
        connect(author);
      }

      const authorForm = document.getElementById("author-form");
      authorForm.addEventListener("submit", function (e) {
        e.preventDefault();

        const author = authorForm.elements["author"].value;
        const color = "#" + authorForm.elements["color"].value;

        // Try to login!
        login(author, color);
      });

      login(sessionStorage.getItem("author"), sessionStorage.getItem("color"));
    </script>
  </body>
</html>
